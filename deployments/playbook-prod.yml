# code: language=ansible
---
- name: Deploy API Production
  hosts: all
  become: true

  vars:
    ansible_user: konsulin
    ansible_python_interpreter: /usr/bin/python3.12
    docker_service_name: prod-api
    deployment_path: "/home/konsulin/be-konsulin/deployments/production"
    deployment_env: "production"
    config_file_name: "config.production.yaml"

    image_repository: konsulin/api-service
    image_tag: ""

    logging:
      driver: "json-file"
      options:
        maxSize: "200k"
        maxFile: "10"

    domain:
      virtual_host: api.konsulin.care
      letsencrypt_host: api.konsulin.care
      letsencrypt_email: mfardiansyah.id@gmail.com

    internal_config:
      app:
        env: "production"
        port: 3001
        version: "v1"
        address: "0.0.0.0"
        base_url: "https://api.konsulin.care/"
        timezone: "Asia/Jakarta"
        endpoint_prefix: "api"
        reset_password_url: "https://app.konsulin.care/reset-password-form?token="
        max_requests: 15
        shutdown_timeout_in_seconds: 3
        max_time_requests_per_seconds: 30
        request_body_limit_in_megabyte: 30
        account_deactivation_age_in_days: 30
        login_session_expired_time_in_hours: 2
        forgot_password_token_expired_time_in_minutes: 2
        minio_pre_signed_url_object_expiry_time_in_hours: 1
        questionnaire_guest_response_response_expired_time_in_minutes: 10

      fhir:
        base_url: "https://blaze.konsulin.care"

      jwt:
        secret: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38643934333636373965633033613335656131346165623133613664656330313130326239303936
          3864373266613663333134646436663165356461363630320a306438333432646364366364326239
          32373234636261313731353332303338376235313139376637383436613837613439626435326466
          3936643734363933300a313063306338623038366363306134386431323739646435633865613135
          32396462633635646466623864643632613861383163613837313835373436653361
        exp_time_in_hour: 1
      mailer:
        email_sender: "funlab.ardihikaru@gmail.com"
      minio:
        profile_picture_max_upload_size_in_mb: 2
        bucket_name: "konsulin-prod"
      rabbitmq:
        mailer_queue: "prod.email"
        whatsapp_queue: "dev.whatsapp"
      mongodb:
        fhir_db_name: "spark"
        konsulin_db_name: "konsulin"
    driver_config:
      mongodb:
        port: 17017
        host: "37.27.46.214"
        username: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31386565656135626330313135326237633432306639363164656365626362336539336461393237
          6237383637363731343662303936343761623266346263340a333033373862633231343630346539
          62613234393032303134393236323435346439396536633835363136353165333339373236656131
          3130333339626137610a663261376662626133363065653930373035663138393765366365663035
          6663
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32666637626262343361623832663862616437623335623436373933323163613837656263633032
          3961393463363539333739643037653632376237623063370a363637306231323136306565316662
          37663936393066353063313334616632663330626663323862303037653262366333643131653231
          6533333231636433300a316434363031613334356231386532636133393637316662366137656237
          63373939663939633363626435333533383865396432323139333637363037626439

      redis:
        host: "37.27.46.214"
        port: 6379
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          33623035623132303335396639626331646661626365356635633065656466666465666366643734
          6661303430613366326132373537383637333231633831380a646230393834336335643839623239
          62383439393233363464646533323533373834373130316533636163653766303735666261343331
          3230396663363130640a643564303235316364626636363963396632326461613166303234346164
          37643363343730316531663536343135393036333430623365346638633636323863

      logger:
        level: "debug"
        output_file_name: "logger.log"
        output_error_file_name: "logger_error.log"

      rabbitmq:
        port: 5672
        host: "37.27.46.214"
        username: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38343661306631643832336663303963306662653530653238643337306262653736666434373664
          3461316139633438643238666431643563623939353634630a343837323732666233363866336264
          39343263643664363961343834313361633539643234623030326336303737396364306337626538
          3337386138356238390a666566383164323834326132636461393035653939626365373561323531
          3261
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32633232356430383939303238653163393265343236393637336563623062366431383131626365
          3466643466303633373166303137666432393738313830640a613532396332306337313665613633
          31306233666131306330366165663761396535656461336566303936333832303230646461343736
          3730616661613664380a336535643465623163626630353062346638613466376335336231663730
          63626630613238393364306237353137393233323638323862633038613761303965

      minio:
        port: 443
        host: "s3.konsulin.care"
        use_ssl: "true"
        username: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30633538346166616636396235643532386134363139636665376263623136353762346532393364
          3231303862653765343933666565333034316631313037350a373563306165316663656330316634
          34383737633562666537316539393663646365623862323635353865396161393161366562363330
          3130393832313838660a626139346432343134396563353332323866386139313330616335333438
          39653663616231646534393235313561373139616663653064393266383663333963
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39376538663738356564303762323061636230316431386333346637356462663965383037346164
          6361323939353037393533633532656230353235363238610a383139326666663565613736376366
          30666261666631393533346334373063333465646265663537653336383332663466653539303162
          6661613738643038350a623763633331343936323032383936656638306632363931363230303832
          61303937626636663437653135613364646230303330353035316636623966376236656261386364
          3763383265646431333832663061326434313332663233633036

  tasks:
    - name: Include deployment tasks
      include_tasks: deploy-task.yml
